# =============================================================================
# Supervisord Configuration
# Manages all services in the single container
# =============================================================================

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
logfile_maxbytes=50MB
logfile_backups=3
loglevel=info

# =============================================================================
# Nginx - Reverse Proxy (Port 80)
# =============================================================================
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
priority=10
stdout_logfile=/var/log/supervisor/nginx.log
stderr_logfile=/var/log/supervisor/nginx_error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB

# =============================================================================
# Gotenberg - Office Document Conversion Service (Port 3001)
# =============================================================================
[program:gotenberg]
command=/usr/local/bin/gotenberg --api-port=3001 --api-timeout=120s --libreoffice-disable-routes=false --log-level=info
autostart=true
autorestart=true
priority=20
user=appuser
environment=HOME="/home/appuser"
stdout_logfile=/var/log/supervisor/gotenberg.log
stderr_logfile=/var/log/supervisor/gotenberg_error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
# Wait for Gotenberg to be ready
startsecs=5
startretries=3

# =============================================================================
# Next.js Application (Port 3000)
# =============================================================================
[program:nextjs]
command=node /app/server.js
directory=/app
autostart=true
autorestart=true
priority=30
user=appuser
environment=NODE_ENV="production",PORT="3000",HOSTNAME="0.0.0.0",GOTENBERG_URL="http://127.0.0.1:3001",HOME="/home/appuser"
stdout_logfile=/var/log/supervisor/nextjs.log
stderr_logfile=/var/log/supervisor/nextjs_error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
startsecs=3
startretries=3

# =============================================================================
# Cron Jobs (Optional - for scheduled tasks)
# =============================================================================
[program:cron]
command=/usr/sbin/cron -f
autostart=true
autorestart=true
priority=5
stdout_logfile=/var/log/supervisor/cron.log
stderr_logfile=/var/log/supervisor/cron_error.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

# =============================================================================
# Log Cleanup - Scheduled Task (runs every day at 3 AM)
# =============================================================================
[program:log-cleanup]
command=/bin/bash -c "while true; do sleep 86400; find /var/log -name '*.log' -mtime +7 -delete 2>/dev/null || true; done"
autostart=true
autorestart=true
priority=100
stdout_logfile=/dev/null
stderr_logfile=/dev/null

# =============================================================================
# Process Group for coordinated control
# =============================================================================
[group:pdftools]
programs=nginx,gotenberg,nextjs
priority=999

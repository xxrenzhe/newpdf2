# =============================================================================
# CI/CD - Build, Docker (GHCR) + 可选 Cloud Run
# =============================================================================
#
# MustKnowV1 部署约束（关键）：
# - push main：构建镜像并推送 tag：prod-latest、prod-{commitid}
# - tag v*.*.*：构建镜像并推送 tag：prod-{version}、prod-{commitid}
# - 单容器部署：supervisord 管理 Nginx(80)/Next.js(3000)/Gotenberg(3001)
#
# 注意：
# - docs/ oldcode/ secrets/ 不能上传 GitHub，也不能打包进镜像（靠 .gitignore/.dockerignore 保证）
#
# =============================================================================

name: CI/CD

on:
  push:
    branches: [main]
    tags: ["v*.*.*"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  BUN_VERSION: "latest"
  IMAGE: ghcr.io/${{ github.repository }}

jobs:
  # ============================================
  # Job 1: CI（Lint）
  # ============================================
  ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4

      - name: 安全检查：禁止跟踪敏感目录
        run: |
          set -euo pipefail
          if git ls-files | grep -E '^(docs/|oldcode/|secrets/)' >/dev/null; then
            echo "❌ 检测到 docs/oldcode/secrets 被 Git 跟踪，请移除后再提交。"
            git ls-files | grep -E '^(docs/|oldcode/|secrets/)' || true
            exit 1
          fi
          echo "✅ 未检测到敏感目录被跟踪"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: 安装依赖（Bun）
        run: bun install --frozen-lockfile

      - name: 代码检查（TypeScript + ESLint）
        run: bun run lint

  # ============================================
  # Job 2: 构建并推送镜像到 GHCR（prod-* tags）
  # ============================================
  docker-ghcr:
    needs: ci
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录 GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 生成镜像标签与元数据
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE }}
          tags: |
            type=raw,value=prod-latest,enable={{is_default_branch}}
            type=sha,format=short,prefix=prod-
            type=semver,pattern={{version}},prefix=prod-

      - name: 构建并推送（GHCR）
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: true

  # ============================================
  # Job 3（可选）：部署到 GCP Cloud Run（自动）
  # ============================================
  deploy-cloud-run:
    needs: docker-ghcr
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    # 注意：job-level `if` 不支持 `secrets.*`（解析阶段不可用），因此这里只校验 vars。
    # 是否真的部署由后续 gate step 再检查 `secrets.GCP_SA_KEY` 决定（缺失则整 job 直接跳过后续步骤并成功结束）。
    if: ${{ vars.GCP_REGION != '' && vars.GCP_CLOUD_RUN_SERVICE != '' && vars.GCP_ARTIFACT_REPOSITORY != '' }}
    env:
      GCP_REGION: ${{ vars.GCP_REGION }}
      CLOUD_RUN_SERVICE: ${{ vars.GCP_CLOUD_RUN_SERVICE }}
      ARTIFACT_REPOSITORY: ${{ vars.GCP_ARTIFACT_REPOSITORY }}
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4

      - name: 检查 Cloud Run 部署开关（缺少 GCP_SA_KEY 则跳过）
        id: gate
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "⚠️ 未配置 secrets.GCP_SA_KEY，跳过 Cloud Run 部署"
            exit 0
          fi
          echo "enabled=true" >> "$GITHUB_OUTPUT"

      - name: 认证到 GCP（Service Account Key）
        id: auth
        uses: google-github-actions/auth@v2
        if: ${{ steps.gate.outputs.enabled == 'true' }}
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        if: ${{ steps.gate.outputs.enabled == 'true' }}

      - name: 准备 Artifact Registry 镜像名
        id: ar
        if: ${{ steps.gate.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail
          PROJECT_ID="${{ steps.auth.outputs.project_id }}"
          if [ -z "$PROJECT_ID" ]; then
            echo "❌ 无法从 GCP_SA_KEY 推断 project_id"
            exit 1
          fi
          echo "project_id=$PROJECT_ID" >> "$GITHUB_OUTPUT"
          echo "host=${{ env.GCP_REGION }}-docker.pkg.dev" >> "$GITHUB_OUTPUT"
          echo "image=${{ env.GCP_REGION }}-docker.pkg.dev/$PROJECT_ID/${{ env.ARTIFACT_REPOSITORY }}/${{ github.event.repository.name }}" >> "$GITHUB_OUTPUT"

      - name: 配置 Docker 登录到 Artifact Registry
        if: ${{ steps.gate.outputs.enabled == 'true' }}
        run: gcloud auth configure-docker ${{ steps.ar.outputs.host }} --quiet

      - name: 生成 Cloud Run 镜像标签（与 GHCR 同步）
        id: meta-ar
        uses: docker/metadata-action@v5
        if: ${{ steps.gate.outputs.enabled == 'true' }}
        with:
          images: ${{ steps.ar.outputs.image }}
          tags: |
            type=raw,value=prod-latest,enable={{is_default_branch}}
            type=sha,format=short,prefix=prod-
            type=semver,pattern={{version}},prefix=prod-

      - name: 构建并推送（Artifact Registry）
        uses: docker/build-push-action@v6
        if: ${{ steps.gate.outputs.enabled == 'true' }}
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta-ar.outputs.tags }}
          labels: ${{ steps.meta-ar.outputs.labels }}
          no-cache: true

      - name: 部署到 Cloud Run（仅更新镜像；环境变量建议由 Secret Manager 注入）
        if: ${{ steps.gate.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail
          IMAGE_TAG="$(echo '${{ steps.meta-ar.outputs.tags }}' | tr ' ' '\n' | head -n 1)"
          echo "Deploying image: $IMAGE_TAG"
          gcloud run deploy "${{ env.CLOUD_RUN_SERVICE }}" \
            --image "$IMAGE_TAG" \
            --region "${{ env.GCP_REGION }}" \
            --platform managed \
            --port 80 \
            --quiet

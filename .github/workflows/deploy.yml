# =============================================================================
# PDF Tools - Build and Test
# =============================================================================
#
# è§¦å‘æ¡ä»¶:
#   - æ¨é€åˆ° main åˆ†æ”¯
#   - ç‰ˆæœ¬æ ‡ç­¾ (v*.*.*)
#   - æ‰‹åŠ¨è§¦å‘
#
# åŠŸèƒ½:
#   - ä»£ç æ£€æŸ¥ (TypeScript, ESLint)
#   - æ„å»º Next.js é¡¹ç›®
#   - æ„å»º Docker é•œåƒ (æœ¬åœ°éªŒè¯ï¼Œä¸æ¨é€)
#
# éƒ¨ç½²æ–¹å¼:
#   - æœ¬åœ°æ„å»ºé•œåƒåæ‰‹åŠ¨éƒ¨ç½²
#
# =============================================================================

name: Build and Test

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  # ============================================
  # Job 1: æ„å»ºå’Œæµ‹è¯•
  # ============================================
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci || npm install

      - name: è¿è¡Œç±»å‹æ£€æŸ¥
        run: npx tsc --noEmit
        continue-on-error: true

      - name: è¿è¡ŒESLint
        run: npm run lint
        continue-on-error: true

      - name: æ„å»ºé¡¹ç›®
        run: npm run build
        env:
          NODE_ENV: production

  # ============================================
  # Job 2: æ„å»ºDockeré•œåƒ (éªŒè¯Dockerfileï¼Œä¸æ¨é€)
  # ============================================
  build-docker:
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: æ„å»ºDockeré•œåƒ (ä¸æ¨é€)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: pdftools:local
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

      - name: è¾“å‡ºæ„å»ºä¿¡æ¯
        run: |
          echo "============================================"
          echo "âœ… Docker é•œåƒæ„å»ºæˆåŠŸ!"
          echo "============================================"
          echo ""
          echo "ğŸš€ æœ¬åœ°æ„å»ºå’Œéƒ¨ç½²:"
          echo ""
          echo "   # æ„å»ºé•œåƒ"
          echo "   docker build -t pdftools:latest ."
          echo ""
          echo "   # è¿è¡Œå®¹å™¨"
          echo "   docker run -d -p 80:80 pdftools:latest"
          echo ""
          echo "============================================"

# =============================================================================
# éƒ¨ç½²è¯´æ˜
# =============================================================================
#
# ğŸ“‹ æ­¤å·¥ä½œæµä¼š:
#    1. è¿è¡Œä»£ç æ£€æŸ¥ (TypeScript, ESLint)
#    2. æ„å»º Next.js é¡¹ç›®
#    3. éªŒè¯ Docker é•œåƒå¯ä»¥æ­£å¸¸æ„å»º
#
# ğŸš€ æœ¬åœ°éƒ¨ç½²æ­¥éª¤:
#    1. å…‹éš†ä»£ç : git clone <repo>
#    2. æ„å»ºé•œåƒ: docker build -t pdftools:latest .
#    3. è¿è¡Œå®¹å™¨: docker run -d -p 80:80 pdftools:latest
#
# ğŸ“ å®¹å™¨æ¶æ„:
#    - Port 80: Nginx (åå‘ä»£ç†)
#    - Port 3000: Next.js (å†…éƒ¨)
#    - Port 3001: Gotenberg (å†…éƒ¨, Officeè½¬PDF)
#    - Supervisord: è¿›ç¨‹ç®¡ç†
#
